#!/usr/bin/env bash

set -euo pipefail

GOKEY_BIN="$(command -v gokey)"
if [[ -z "$GOKEY_BIN" ]]; then
    echo "gokey is not installed. Please install gokey to use this script."
    echo
    echo "Refer to: https://github.com/cloudflare/gokey"
    exit 1
fi

COPY_BIN="$(command -v cross-copy)"
if [[ -z "$COPY_BIN" ]]; then
    echo "cross-copy is not installed. Please install cross-copy to use this script."
    echo
    echo "Refer to: https://github.com/hwhang0917/dotfiles"
    exit 1
fi

GOKEY_CONF_DIR="$HOME/.gokey"
if [[ ! -d "$GOKEY_CONF_DIR" ]]; then
    echo "gokey configuration directory not found at $GOKEY_CONF_DIR. Please initialize gokey first."
    exit 1
fi

MASTER_PASSWORD_FILE="$GOKEY_CONF_DIR/master-password"
if [[ ! -f "$MASTER_PASSWORD_FILE" ]]; then
    echo "Master password file not found at $MASTER_PASSWORD_FILE. Please initialize gokey first."
    exit 1
fi

SEED_FILE="$GOKEY_CONF_DIR/seedfile"
if [[ ! -f "$SEED_FILE" ]]; then
    echo "Seed file not found at $SEED_FILE. Please initialize gokey first."
    exit 1
fi

# Parse arguments
realm=""
length=""

while [[ $# -gt 0 ]]; do
    case "$1" in
        -v)
            set -x
            shift
            ;;
        -l)
            length="$2"
            shift 2
            ;;
        -*)
            echo "Unknown option: $1"
            exit 1
            ;;
        *)
            realm="$1"
            shift
            ;;
    esac
done

# Prompt user to enter realm if not provided
if [[ -z "$realm" ]]; then
    read -p "Enter realm: " realm
fi

if [[ -z "$realm" ]]; then
    echo "Error: realm cannot be empty"
    exit 1
fi

# Build gokey command
gokey_cmd=("$GOKEY_BIN" -P "${MASTER_PASSWORD_FILE}" -s "${SEED_FILE}" -r "$realm" -t pass)
if [[ -n "$length" ]]; then
    gokey_cmd+=(-l "$length")
fi

# Run gokey and pipe to cross-copy
if "${gokey_cmd[@]}" | "$COPY_BIN"; then
    echo "✓ Key generated and copied to clipboard for realm: $realm"
else
    echo "✗ Failed to generate or copy key"
    exit 1
fi
